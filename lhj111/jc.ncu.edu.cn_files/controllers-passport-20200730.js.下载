'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

angular.module('myApp.controllers_generator', [])
//生成ID
.controller('generatorCtrl', ['$scope', '$rootScope', '$http', '$timeout', function ($scope, $rootScope, $http, $timeout) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();
    $rootScope.currentApp = 'cardId';

    $scope.avatarFileName = "";
    $scope.avatarFile = null;
    $scope.avatarOriginalFile = null;

    $scope.formField = {
        'name': null,
        'sex': null,
        'number': null,
        'mobile': null,
        'idCard': null,
        'class': null,
        'campus': null
    };

    $scope.formField.name = $rootScope.userData.userName ? $rootScope.userData.userName : null;
    $scope.formField.sex = $rootScope.userData.sex ? $rootScope.userData.sex : null;
    $scope.formField.number = $rootScope.userData.userId ? $rootScope.userData.userId : null;
    $scope.formField.mobile = $rootScope.userData.mobile ? parseInt($rootScope.userData.mobile) : null;
    $scope.formField.idCard = $rootScope.userData.idCard ? $rootScope.userData.idCard : null;
    $scope.formField.className = $rootScope.userData.className ? $rootScope.userData.className : null;
    $scope.formField.collegeName = $rootScope.userData.collegeName ? $rootScope.userData.collegeName : null;
    $scope.formField.majorName = $rootScope.userData.majorName ? $rootScope.userData.majorName : null;
    $scope.formField.grade = $rootScope.userData.grade ? $rootScope.userData.grade : null;
    $scope.formField.campus = $rootScope.userData.campus ? $rootScope.userData.campus : null;
    $scope.formField.deptName = $rootScope.userData.deptName ? $rootScope.userData.deptName : null;
    $scope.formField.userType = $rootScope.userData.userType ? $rootScope.userData.userType : null;

    $scope.take_photo = function () {};

    // 生成电子ID
    $scope.generator = function () {
        // $rootScope.avatar = $('.cropped_image').attr('src');
        // console.info($rootScope.avatar);
        // $scope.uploadPhoto((imgPath) => {
        $scope.uploadPhotoBase64(function (imgPath) {
            $scope.imgPath = imgPath;
            $scope.addCard(function () {
                $rootScope.userData.cardStatus = 1;
                $rootScope.go('/passport');
            });
        });
        // $rootScope.generate_photo($rootScope.avatar, $('#idCard').val());
    };

    // $scope.photo_button = () => {
    //     jQuery('#avatar_input').click();
    // };
    //
    // $(document).on('touchstart', '#photo-button', () => {
    //     console.info('xxxxx');
    //     jQuery('#avatar_input').click();
    // });

    $scope.uploadPhoto = function (callback) {
        var formData = new FormData();
        formData.append("file", $scope.avatarFile);

        $http.post($rootScope.apiUrl + "/system/file/upload",
        // 'http://jcapi.ncu.edu.cn:8090/thirdapi/file/uploadImg',
        formData, {
            transformRequest: angular.identity,
            headers: { 'Content-Type': undefined }
        }).success(function (response) {
            if (response.code == 0) {
                if (!!response.data && response.data != "") {
                    callback && callback(response.data);
                } else {
                    alert(response.message);
                }
            } else {
                alert(response.message);
            }
        });
    };
    $scope.uploadPhotoBase64 = function (callback) {
        var formData = new FormData();
        console.info($scope.avatarFile);
        formData.append("fileStr", $scope.cropperBase64);

        $http.post($rootScope.apiUrl + "/system/file/uploadImgBase64",
        // 'http://jcapi.ncu.edu.cn:8090/thirdapi/file/uploadImgBase64',
        formData, {
            transformRequest: angular.identity,
            headers: { 'Content-Type': undefined }
        }).success(function (response) {
            if (response.code == 0) {
                if (!!response.data && response.data != "") {
                    callback && callback(response.data);
                } else {
                    alert(response.message);
                }
            } else {
                alert(response.message);
            }
        });
    };

    $scope.addCard = function (callback) {
        var data = {
            userId: $scope.formField.number,
            mobile: $scope.formField.mobile,
            idCard: $scope.formField.idCard,
            type: $scope.formField.userType,
            imgPath: $scope.imgPath
        };
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/card/addCard',
            method: 'post',
            // contentType: 'application/json;charset=UTF-8',
            traditional: true,
            data: data,
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                var userData = $rootScope.userData;
                userData['cardId'] = response.data;
                userData['avatar'] = $scope.imgPath;
                userData['mobile'] = $scope.formField.mobile;
                userData['idCard'] = $scope.formField.idCard;
                $rootScope.setUserData(userData);
                callback && callback();
            } else if (response.code == 1) {
                alert(response.message);
            } else {
                alert(response.message);
            }
        });
    };

    $scope.myImagePreview = null;
    $scope.myCroppedImage = '';
    $scope.cropped_image_show = false;
    $scope.cropper = null;

    var handleFileSelect = function handleFileSelect(evt) {
        if (!!$scope.cropper) {
            $scope.cropper.destroy();
        }

        $scope.avatarOriginalFile = evt.currentTarget.files[0];
        $scope.avatarFileName = $scope.avatarOriginalFile.name;
        var reader = new FileReader();
        reader.onload = function (evt) {
            $('#avatar_cropped_modal').removeClass('offscreen');
            $('.modal-backdrop').fadeIn();
            // $('#avatar_cropped_modal').modal('show');
            $scope.$apply(function ($scope) {
                $scope.myImagePreview = evt.target.result;
            });
            setTimeout(function () {
                $scope.cropper = new Cropper($('#cropper')[0], {
                    autoCrop: false,
                    aspectRatio: 1,
                    viewMode: 2,
                    responsive: true,
                    background: false,
                    autoCropArea: 1,
                    minCropBoxWidth: 200,
                    minCropBoxHeight: 200,
                    ready: function ready() {
                        this.cropper.crop();
                    }
                });
            }, 300);
        };
        reader.readAsDataURL($scope.avatarOriginalFile);
    };
    angular.element(document.querySelector('#avatar_input')).on('change', handleFileSelect);

    $scope.show_modal = function () {
        // $('#avatar_cropped_modal').modal('show');
        $('#avatar_cropped_modal').removeClass('offscreen');
        $('.modal-backdrop').fadeIn();
    };
    $scope.cropped = function () {
        $scope.cropperBase64 = null;

        // $('#avatar_cropped_modal').modal('hide');
        $('#avatar_cropped_modal').addClass('offscreen');
        $('.modal-backdrop').fadeOut();

        // $scope.cropper.data('cropper');
        $scope.cropperBase64 = $scope.cropper.getCroppedCanvas({
            // imageSmoothingEnabled: false,
            imageSmoothingQuality: "high",
            maxWidth: 2500,
            maxHeight: 2500
        }).toDataURL('image/jpeg', 0.8);
        $scope.myCroppedImage = $scope.cropperBase64;
        $scope.cropped_image_show = true;
        console.info($scope.cropperBase64);

        // try {
        //     $scope.avatarFile = new File([$rootScope.base64ToBlob($scope.cropperBase64)], $scope.avatarFileName);
        // } catch(err) {
        //     $scope.avatarFile = $scope.avatarOriginalFile; // 提交原始照片文件
        // }
        //
        // if(($scope.avatarFile.size / 1024).toFixed(2) <= 2){
        //     console.info(($scope.avatarFile.size / 1024).toFixed(2) + 'kb');
        //     $scope.avatarFile = $scope.avatarOriginalFile; // 提交原始照片文件
        //     // alert('照片文件获取错误');
        // }else{
        // }

        // 文件类型为空
        // if(!$scope.avatarFile.type || $scope.avatarFile.type == ""){
        //     $scope.avatarFile = $scope.avatarOriginalFile;
        // }
    };

    $scope.imgCropDone = function (e) {
        console.info(e);
    };

    // 表单校验
    var forms = $('form');
    var validation = Array.prototype.filter.call(forms, function (form) {
        form.addEventListener('submit', function (event) {
            $('.custom-select, .form-control').removeClass('invalid valid');
            $('.avatar_input-feedback').removeClass('invalid valid');
            var validityFlag = false;

            // if($scope.avatarFile == null){
            if ($scope.avatarOriginalFile == null) {
                validityFlag = true;
                $('.avatar_input-feedback').addClass('invalid');
            }

            if (form.checkValidity() === false || validityFlag) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                $scope.generator();
            }
            form.classList.add('was-validated');
        }, false);
    });
}]);

angular.module('myApp.controllers_passport', [])
//查看ID
.controller('passportCtrl', ['$scope', '$rootScope', '$http', '$interval', function ($scope, $rootScope, $http, $interval) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();
    $rootScope.currentApp = 'cardId';

    $scope.pageInit = function () {
        if (!$rootScope.clockInterval) {
            $rootScope.clockInterval = $interval($rootScope.clock, 1000);
        }
    };

    $scope.userRoleId = $rootScope.userData != {} && $rootScope.userData.roleId;
    $scope.token = $rootScope.work_weixin.token;
    $scope.userdata = JSON.stringify($rootScope.userData);
    $scope.passport = {
        'qr': null,
        'name': null,
        'sex': null,
        'photo': null,
        'number': null,
        'mobile': null,
        'idCard': null,
        'class': null,
        'campus': null
    };

    $scope.passport.qr = $rootScope.userData.cardId ? $rootScope.userData.cardId : null;
    $scope.passport.name = $rootScope.userData.userName ? $rootScope.userData.userName : null;
    $scope.passport.sex = $rootScope.userData.sex ? $rootScope.userData.sex : null;
    $scope.passport.avatar = $rootScope.userData.avatar ? $rootScope.userData.avatar : null;
    $scope.passport.number = $rootScope.userData.userId ? $rootScope.userData.userId : null;
    $scope.passport.mobile = $rootScope.userData.mobile ? parseInt($rootScope.userData.mobile) : null;
    $scope.passport.idCard = $rootScope.userData.idCard ? $rootScope.userData.idCard : null;
    $scope.passport.className = $rootScope.userData.className ? $rootScope.userData.className : null;
    $scope.passport.collegeName = $rootScope.userData.collegeName ? $rootScope.userData.collegeName : null;
    $scope.passport.majorName = $rootScope.userData.majorName ? $rootScope.userData.majorName : null;
    $scope.passport.grade = $rootScope.userData.grade ? $rootScope.userData.grade : null;
    $scope.passport.campus = $rootScope.userData.campus ? $rootScope.userData.campus : null;
    $scope.passport.deptName = $rootScope.userData.deptName ? $rootScope.userData.deptName : null;
    $scope.passport.userType = $rootScope.userData.userType ? $rootScope.userData.userType : null;

    $scope.goto_list_approved = function () {
        $rootScope.go('/list_approved');
    };
    $scope.goto_list_apply = function () {
        $rootScope.go('/list_apply');
    };
    $scope.goto_gate_sign = function () {
        $rootScope.go('/gate_sign');
    };

    // 生成二维码
    var generateQRCodeCanvas = function generateQRCodeCanvas() {
        var text = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : $scope.passport.qr;
        var foreground = arguments[1];
        var background = arguments[2];
        var type = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

        if (!$scope.passport.qr) {
            $rootScope.re_login();
            return false;
        }

        var options = {
            typeNumber: -1,
            correctLevel: QRErrorCorrectLevel.H,
            width: type == 1 ? 150 : 180,
            height: type == 1 ? 150 : 180,
            background: background ? background : "#ffffff",
            foreground: foreground ? foreground : "#163a7b",
            text: text
        };

        var qrcode = new QRCode(options.typeNumber, options.correctLevel);
        qrcode.addData(options.text);
        qrcode.make();

        // create canvas element
        var canvas = document.createElement('canvas');
        canvas.width = options.width;
        canvas.height = options.height;
        var ctx = canvas.getContext('2d');

        // compute tileW/tileH based on options.width/options.height
        var tileW = options.width / qrcode.getModuleCount();
        var tileH = options.height / qrcode.getModuleCount();

        // draw in the canvas
        for (var row = 0; row < qrcode.getModuleCount(); row++) {
            for (var col = 0; col < qrcode.getModuleCount(); col++) {
                ctx.fillStyle = qrcode.isDark(row, col) ? options.foreground : options.background;
                var w = Math.ceil((col + 1) * tileW) - Math.floor(col * tileW);
                var h = Math.ceil((row + 1) * tileW) - Math.floor(row * tileW);
                ctx.fillRect(Math.round(col * tileW), Math.round(row * tileH), w, h);
            }
        }
        ctx.globalAlpha = 0;
        jQuery('.qr-code-canvas .canvas').html(canvas);
    };
    generateQRCodeCanvas();

    // 获取校区识别卡

    $scope.campusItineraryList = {
        '100002': 0,
        '100004': 0,
        '100001': 0,
        '100003': 0
    };
    $scope.getCampusItinerary = function () {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/queryList',
            method: 'post',
            data: {
                isCheck: 1
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                if (response.data && response.data.length > 0) {
                    var nowTime = new Date().Format('yyyy-MM-dd hh:mm:ss');
                    var _iteratorNormalCompletion = true;
                    var _didIteratorError = false;
                    var _iteratorError = undefined;

                    try {
                        for (var _iterator = response.data[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                            var item = _step.value;

                            if (item.startTime <= nowTime && item.endTime >= nowTime && item.status == '1' && item.campusId) {
                                // 当天的许可列表
                                $scope.campusItineraryList[item.campusId] = ++$scope.campusItineraryList[item.campusId];
                            }
                        }
                    } catch (err) {
                        _didIteratorError = true;
                        _iteratorError = err;
                    } finally {
                        try {
                            if (!_iteratorNormalCompletion && _iterator.return) {
                                _iterator.return();
                            }
                        } finally {
                            if (_didIteratorError) {
                                throw _iteratorError;
                            }
                        }
                    }
                }

                // 学生
                if ($scope.passport.userType == 1) {
                    $scope.renderCampusBox();
                    var foreground = "#163a7b";
                    var background = "#ffffff";
                    if ($rootScope.userData.cardStatus == 0) {
                        // 长期通行
                        $scope.stuCardGreen();
                        foreground = "#163a7b";
                    } else if ($rootScope.userData.cardStatus == 1) {
                        // 要看通行许可
                        if ($scope.campusItineraryList[100001] > 0 || $scope.campusItineraryList[100002] > 0 || $scope.campusItineraryList[100003] > 0 || $scope.campusItineraryList[100004] > 0) {
                            $scope.stuCardGreen();
                            foreground = "#163a7b";
                        } else {
                            $scope.stuCardRed();
                            foreground = "#ff4222";
                            $('.stuNoentry').fadeIn();
                        }
                    } else if ($rootScope.userData.cardStatus == 2) {
                        // 在人事处名单即可长期通行
                        $scope.stuCardGreen();
                        foreground = "#163a7b";
                    } else if ($rootScope.userData.cardStatus == 3) {
                        // 通行证失效
                        $scope.stuCardRed();
                        foreground = "#ff4222";
                        $('.nopassport').fadeIn();
                    } else if ($rootScope.userData.cardStatus == 4) {
                        // 黄码
                        $scope.stuCardYellow();
                        foreground = "#ffb400";
                    }
                    generateQRCodeCanvas($scope.passport.qr, foreground, background, 1);
                } else {
                    var _foreground = "#3d9e00";

                    // 4.23在广东，黑龙江打卡1
                    if ($rootScope.noEntryUserId.indexOf($rootScope.userData.userId) >= 0) {
                        $('#unapply-buttons').fadeIn();
                        $('.qr-box-card').addClass('red').removeClass('green');
                        $('.user-info-card').addClass('red').removeClass('green');
                        $('.campus-box').removeClass('active');
                        _foreground = "#ff4222";
                        $('.epidemicArea').fadeIn();
                    } else {
                        $rootScope.isSignSafe(function (SignSafe) {
                            // $scope.isSafe((isSafe) => {
                            if ($rootScope.userData.cardStatus == 0) {
                                // 长期通行
                                $scope.cardGreen();
                                _foreground = "#3d9e00";
                            } else if ($rootScope.userData.cardStatus == 1) {
                                // 要看通行许可
                                // if(isSafe) {
                                // if (flag) { // 是否有教师出行申请
                                //     $scope.cardGreen();
                                //     foreground = "#3d9e00";
                                // } else {
                                //     if ($scope.campusItineraryList[$scope.guardCampusId] > 0) {

                                if (SignSafe.safe) {
                                    $scope.cardGreen();
                                    _foreground = "#3d9e00";
                                } else {
                                    $scope.cardRed();
                                    _foreground = "#ff4222";
                                    $('.isSignSafeResult').html(SignSafe.result).fadeIn();
                                }
                                // } else {
                                //     $scope.cardRed();
                                //     $('.noentry').fadeIn();
                                // }
                                // }
                                // }else{
                                //     $scope.cardRed();
                                //     foreground = "#ff4222";
                                //     $('.unsafe').fadeIn();
                                // }
                            } else if ($rootScope.userData.cardStatus == 2) {
                                // 在人事处名单即可长期通行
                                $scope.cardGreen();
                                _foreground = "#3d9e00";
                            } else if ($rootScope.userData.cardStatus == 3) {
                                // 通行证失效
                                $scope.cardRed();
                                _foreground = "#ff4222";
                                $('.nopassport').fadeIn();
                            }
                            generateQRCodeCanvas($scope.passport.qr, _foreground);
                            // });
                            // $scope.getCampusItinerary();
                        });
                    }
                }
            } else {
                alert(response.message);
            }
        });
    };

    $scope.renderCampusBox = function () {
        console.info($scope.campusItineraryList);
        for (var i in $scope.campusItineraryList) {
            if ($scope.campusItineraryList[i] > 0) {
                $('.campus-box.campus_id-' + i).addClass('active');
            }
        }
    };

    $scope.stuCardYellow = function () {
        $('.qr-box-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.user-info-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').removeClass('student-qrcode-blue').addClass('student-qrcode-yellow');
    };

    $scope.stuCardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').addClass('student-qrcode-blue');
    };

    $scope.stuCardRed = function () {
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.qr-code-canvas').removeClass('student-qrcode-blue').addClass('student-qrcode-red');
    };

    $scope.cardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.campus-box').addClass('active');
    };

    $scope.cardRed = function () {
        $('.redcode').fadeIn();
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.campus-box').removeClass('active');
    };
    // $scope.cardGreen();
    $scope.getCampusItinerary();
}]);

angular.module('myApp.controllers_guard', [])
//用户扫门岗通行
.controller('guardCtrl', ['$scope', '$rootScope', '$http', '$interval', function ($scope, $rootScope, $http, $interval) {
    $rootScope.$on('$locationChangeStart', function (e, to, from) {
        e.preventDefault();
    });
    window.addEventListener('popstate', function (e) {
        e.preventDefault();
        // wx.closeWindow();
    });

    //️ TEST ⚡️
    // $rootScope.getToken();
    // $rootScope.getUserData();
    // let result = window.getRequest();
    // if(result.state && result.state != "STATE" && /^[0-9-_]+$/.test(result.state)) {
    //     $rootScope.guardCode = result.state;
    // }

    $scope.token = $rootScope.work_weixin.token;
    $scope.userdata = JSON.stringify($rootScope.userData);
    $scope.passport = {
        'qr': null,
        'name': null,
        'sex': null,
        'photo': null,
        'number': null,
        'mobile': null,
        'idCard': null,
        'class': null,
        'campus': null
    };
    $scope.guardCampusId = null;
    $scope.guardGateId = null;
    $scope.guardGateStatus = 0;
    $scope.guardName = null;
    $scope.campusId = null;
    $scope.guardNameData = {
        'qhb': '前湖北校区',
        'qhn': '前湖南校区',
        'qsh': '青山湖校区',
        'dh': '东湖校区'
    };
    $scope.checkReark = "";
    $scope.formField = {
        temperature: window.RandomNumBoth(358, 367) / 10
    };

    $scope.passport.qr = $rootScope.userData.cardId ? $rootScope.userData.cardId : null;
    $scope.passport.name = $rootScope.userData.userName ? $rootScope.userData.userName : null;
    $scope.passport.sex = $rootScope.userData.sex ? $rootScope.userData.sex : null;
    $scope.passport.avatar = $rootScope.userData.avatar ? $rootScope.userData.avatar : null;
    $scope.passport.number = $rootScope.userData.userId ? $rootScope.userData.userId : null;
    $scope.passport.mobile = $rootScope.userData.mobile ? $rootScope.userData.mobile : null;
    $scope.passport.idCard = $rootScope.userData.idCard ? $rootScope.userData.idCard : null;
    $scope.passport.className = $rootScope.userData.className ? $rootScope.userData.className : null;
    $scope.passport.collegeName = $rootScope.userData.collegeName ? $rootScope.userData.collegeName : null;
    $scope.passport.majorName = $rootScope.userData.majorName ? $rootScope.userData.majorName : null;
    $scope.passport.grade = $rootScope.userData.grade ? $rootScope.userData.grade : null;
    $scope.passport.campus = $rootScope.userData.campus ? $rootScope.userData.campus : null;
    $scope.passport.deptName = $rootScope.userData.deptName ? $rootScope.userData.deptName : null;
    $scope.passport.userType = $rootScope.userData.userType ? $rootScope.userData.userType : null;

    if ($scope.passport.mobile.length == 11) $scope.passport.mobile = $scope.passport.mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
    if ($scope.passport.idCard.length == 18) $scope.passport.idCard = $scope.passport.idCard.replace(/^(.{6})(?:\d+)(.{4})$/, "$1********$2");

    // 生成二维码
    var generateQRCodeCanvas = function generateQRCodeCanvas() {
        var text = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : $scope.passport.qr;
        var foreground = arguments[1];
        var background = arguments[2];
        var type = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

        if (!$scope.passport.qr) {
            $rootScope.re_login();
            return false;
        }

        var options = {
            typeNumber: -1,
            correctLevel: QRErrorCorrectLevel.H,
            width: type == 1 ? 150 : 180,
            height: type == 1 ? 150 : 180,
            background: background ? background : "#ffffff",
            foreground: foreground ? foreground : "#163a7b",
            text: text
        };

        var qrcode = new QRCode(options.typeNumber, options.correctLevel);
        qrcode.addData(options.text);
        qrcode.make();

        // create canvas element
        var canvas = document.createElement('canvas');
        canvas.width = options.width;
        canvas.height = options.height;
        var ctx = canvas.getContext('2d');

        // compute tileW/tileH based on options.width/options.height
        var tileW = options.width / qrcode.getModuleCount();
        var tileH = options.height / qrcode.getModuleCount();

        // draw in the canvas
        for (var row = 0; row < qrcode.getModuleCount(); row++) {
            for (var col = 0; col < qrcode.getModuleCount(); col++) {
                ctx.fillStyle = qrcode.isDark(row, col) ? options.foreground : options.background;
                var w = Math.ceil((col + 1) * tileW) - Math.floor(col * tileW);
                var h = Math.ceil((row + 1) * tileW) - Math.floor(row * tileW);
                ctx.fillRect(Math.round(col * tileW), Math.round(row * tileH), w, h);
            }
        }
        ctx.globalAlpha = 0;
        jQuery('.qr-code-canvas .canvas').html(canvas);
    };

    // 获取当前门岗
    $scope.getGuardCode = function () {
        if ($rootScope.guardCode) {
            $scope.guardCampusId = $rootScope.guardCode.split('_')[0];
            $scope.guardGateId = $rootScope.guardCode.split('_')[1];
            $scope.getCampusItinerary();
        }
    };

    // 获取校区识别卡
    $scope.campusItineraryList = {
        '100002': 0,
        '100004': 0,
        '100001': 0,
        '100003': 0
    };
    $scope.getCampusItinerary = function () {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/queryList',
            method: 'post',
            data: {
                isCheck: 1
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                if (response.data && response.data.length > 0) {
                    var nowTime = new Date().Format('yyyy-MM-dd hh:mm:ss');
                    var _iteratorNormalCompletion2 = true;
                    var _didIteratorError2 = false;
                    var _iteratorError2 = undefined;

                    try {
                        for (var _iterator2 = response.data[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                            var item = _step2.value;

                            if (item.startTime <= nowTime && item.endTime >= nowTime && item.status == '1' && item.campusId) {
                                // 当天的许可列表
                                $scope.campusItineraryList[item.campusId] = ++$scope.campusItineraryList[item.campusId];
                            }
                        }
                    } catch (err) {
                        _didIteratorError2 = true;
                        _iteratorError2 = err;
                    } finally {
                        try {
                            if (!_iteratorNormalCompletion2 && _iterator2.return) {
                                _iterator2.return();
                            }
                        } finally {
                            if (_didIteratorError2) {
                                throw _iteratorError2;
                            }
                        }
                    }
                }
            }

            // 学生
            if ($scope.passport.userType == 1) {
                $scope.renderCampusBox();
                $scope.getGuardId(function (gateId) {
                    var foreground = "#163a7b";
                    var background = "#ffffff";
                    if ($rootScope.userData.cardStatus == 0) {
                        // 长期通行
                        $('#temperature_modal').modal({ backdrop: 'static', keyboard: false });
                        $scope.stuCardGreen();
                        foreground = "#163a7b";
                    } else if ($rootScope.userData.cardStatus == 1) {
                        // 要看通行许可
                        // 判断是校门看许可
                        var isSchoolGate = false;
                        var _iteratorNormalCompletion3 = true;
                        var _didIteratorError3 = false;
                        var _iteratorError3 = undefined;

                        try {
                            for (var _iterator3 = $rootScope.schoolGateId[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                                var _item = _step3.value;

                                if (_item == $scope.guardGateId) {
                                    isSchoolGate = true;
                                    break;
                                }
                            }
                        } catch (err) {
                            _didIteratorError3 = true;
                            _iteratorError3 = err;
                        } finally {
                            try {
                                if (!_iteratorNormalCompletion3 && _iterator3.return) {
                                    _iterator3.return();
                                }
                            } finally {
                                if (_didIteratorError3) {
                                    throw _iteratorError3;
                                }
                            }
                        }

                        if (!isSchoolGate) {
                            // 不是校门
                            $scope.sendGuardCheck(0, { temperature: $scope.formField.temperature });
                        }
                        if ($scope.campusItineraryList[$scope.guardCampusId] > 0) {
                            $('#temperature_modal').modal({ backdrop: 'static', keyboard: false });
                            $scope.stuCardGreen();
                            foreground = "#163a7b";
                        } else {
                            $scope.stuCardRed();
                            foreground = "#ff4222";
                            $('.stuNoentry').fadeIn();
                        }
                    } else if ($rootScope.userData.cardStatus == 2) {
                        // 在人事处名单即可长期通行
                        $('#temperature_modal').modal({ backdrop: 'static', keyboard: false });
                        $scope.stuCardGreen();
                        foreground = "#163a7b";
                    } else if ($rootScope.userData.cardStatus == 3) {
                        // 通行证失效
                        $scope.stuCardRed();
                        foreground = "#ff4222";
                        $('.nopassport').fadeIn();
                    } else if ($rootScope.userData.cardStatus == 4) {
                        // 黄码
                        $('#temperature_modal').modal({ backdrop: 'static', keyboard: false });
                        $scope.stuCardYellow();
                        foreground = "#ffb400";
                    }
                    generateQRCodeCanvas($scope.passport.qr, foreground, background, 1);
                });
            } else {
                var foreground = "#3d9e00";
                // 4.23在广东，黑龙江打卡1
                if ($rootScope.noEntryUserId.indexOf($rootScope.userData.userId) >= 0) {
                    $('#unapply-buttons').fadeIn();
                    $('.qr-box-card').addClass('red').removeClass('green');
                    $('.user-info-card').addClass('red').removeClass('green');
                    $('.campus-box').removeClass('active');
                    foreground = "#ff4222";
                    $('.epidemicArea').fadeIn();
                } else {
                    // $scope.verificationUserItinerary((flag) => {
                    $scope.getGuardId(function (gateId) {
                        $rootScope.isSignSafe(function (SignSafe) {
                            // $scope.isSafe((isSafe) => {
                            if ($rootScope.userData.cardStatus == 0) {
                                // 长期通行
                                $scope.sendGuardCheck(0);
                                $scope.cardGreen();
                                foreground = "#3d9e00";
                            } else if ($rootScope.userData.cardStatus == 1) {
                                // 要看通行许可
                                // if(isSafe) {
                                // if (flag) { // 是否有教师出行申请
                                // $scope.sendGuardCheck(0);
                                //     $scope.cardGreen();
                                //     foreground = "#3d9e00";
                                // } else {
                                //     if ($scope.campusItineraryList[$scope.guardCampusId] > 0) {

                                if (SignSafe.safe) {
                                    $scope.sendGuardCheck(0);
                                    $scope.cardGreen();
                                    foreground = "#3d9e00";
                                } else {
                                    $scope.cardRed();
                                    foreground = "#ff4222";
                                    $('.isSignSafeResult').html(SignSafe.result).fadeIn();
                                }
                                // } else {
                                //     $scope.cardRed();
                                //     $('.noentry').fadeIn();
                                // }
                                // }
                                // }else{
                                //     $scope.cardRed();
                                //     foreground = "#ff4222";
                                //     $('.unsafe').fadeIn();
                                // }
                            } else if ($rootScope.userData.cardStatus == 2) {
                                // 在人事处名单即可长期通行
                                $scope.sendGuardCheck(0);
                                $scope.cardGreen();
                                foreground = "#3d9e00";
                            } else if ($rootScope.userData.cardStatus == 3) {
                                // 通行证失效
                                $scope.cardRed();
                                foreground = "#ff4222";
                                $('.nopassport').fadeIn();
                            }
                            generateQRCodeCanvas($scope.passport.qr, foreground);
                            // });
                        });
                    });
                    // });
                }
            }
        });
    };

    // 表单校验
    var temperature_modal_forms = $('#temperature_modal form');
    var validation = Array.prototype.filter.call(temperature_modal_forms, function (form) {
        form.addEventListener('submit', function (event) {
            if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                $('#temperature-btn').attr('disabled', 'disabled');
                $('#temperature_modal').modal('hide');
                $scope.sendGuardCheck(0, { temperature: $scope.formField.temperature });
            }
            form.classList.add('was-validated');
        }, false);
    });

    $scope.stuCardYellow = function () {
        $('.qr-box-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.user-info-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').removeClass('student-qrcode-blue').addClass('student-qrcode-yellow');
    };

    $scope.stuCardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').addClass('student-qrcode-blue');
    };

    $scope.stuCardRed = function () {
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.qr-code-canvas').removeClass('student-qrcode-blue').addClass('student-qrcode-red');
    };

    $scope.cardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.campus-box').addClass('active');
    };

    $scope.cardRed = function () {
        $('.redcode').fadeIn();
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.campus-box').removeClass('active');
    };

    // 人事处的返校名单，符合隔离要求
    $scope.isSafe = function (callback) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/isSafe',
            method: 'post',
            data: {
                userId: $rootScope.userData.userId
                // userId: '091264',
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            // alert('isSafe: ' + JSON.stringify(response));
            if (response.code == 0) {
                callback && callback(response.data);
            }
        });
    };

    // 是否有教师出行申请
    $scope.doGetTeacherRegistrationList = function (callback) {
        var qwxq = {
            '100004': '0', // 前湖南校区
            '100002': '1', // 前湖北校区
            '100001': '2', // 青山湖校区
            '100003': '3' // 东湖校区
        };
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/doRequest/dogetTeacherRegistrationList',
            method: 'post',
            traditional: true,
            data: {
                userCode: $rootScope.userData.userId,
                qwxq: qwxq[$scope.guardCampusId]
            }
        }).then(function (response) {
            console.info(response);
            if (response.status == "200") {
                var flag = false;
                if (response.data && response.data.length > 0) {
                    var _iteratorNormalCompletion4 = true;
                    var _didIteratorError4 = false;
                    var _iteratorError4 = undefined;

                    try {
                        for (var _iterator4 = response.data[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                            var _item2 = _step4.value;

                            var isDuringDate = window.isDuringDate(_item2.yjlaixsj, _item2.yjlxsj);
                            if (!!isDuringDate) {
                                if (_item2.qwxq == qwxq[$scope.guardCampusId]) {
                                    flag = true;
                                }
                                for (var xq in qwxq) {
                                    if (qwxq[xq] == _item2.qwxq) {
                                        $scope.campusItineraryList[xq] = ++$scope.campusItineraryList[xq];
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        _didIteratorError4 = true;
                        _iteratorError4 = err;
                    } finally {
                        try {
                            if (!_iteratorNormalCompletion4 && _iterator4.return) {
                                _iterator4.return();
                            }
                        } finally {
                            if (_didIteratorError4) {
                                throw _iteratorError4;
                            }
                        }
                    }
                } // $scope.renderCampusBox();
                callback && callback(flag);
            }
        });
    };

    $scope.verificationUserItinerary = function (callback) {
        // $scope.doGetTeacherRegistrationList((flag) => {
        //     callback && callback(flag);
        // });
    };

    // 绘制校区色块
    $scope.renderCampusBox = function () {
        console.info($scope.campusItineraryList);
        for (var i in $scope.campusItineraryList) {
            if ($scope.campusItineraryList[i] > 0) {
                $('.campus-box.campus_id-' + i).addClass('active');
            }
        }
    };

    // 入校记录
    $scope.sendGuardCheck = function (status) {
        var temperature = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/check',
            method: 'post',
            data: _extends({
                status: status }, temperature, {
                userId: $rootScope.userData.userId,
                cardId: $rootScope.userData.cardId,
                gateId: $scope.guardGateId,
                userName: $rootScope.userData.userName,
                deptName: $rootScope.userData.deptName
            }),
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {} else {
                alert(response.message);
            }
        });
    };

    // 查询门岗id
    $scope.getGuardId = function (callback) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/queryList',
            method: 'post',
            data: {
                campusId: $scope.guardCampusId
                // guardId:
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                var _iteratorNormalCompletion5 = true;
                var _didIteratorError5 = false;
                var _iteratorError5 = undefined;

                try {
                    var _loop = function _loop() {
                        var item = _step5.value;

                        if (item.campusId == $scope.guardCampusId && item.gateId == $scope.guardGateId) {
                            $scope.$apply(function ($scope) {
                                $scope.campusId = item.campusId;
                                $scope.guardName = item.campusName + ' ' + item.gateName;
                            });
                            callback && callback(item.gateId);
                        }
                    };

                    for (var _iterator5 = response.data[Symbol.iterator](), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
                        _loop();
                    }
                } catch (err) {
                    _didIteratorError5 = true;
                    _iteratorError5 = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion5 && _iterator5.return) {
                            _iterator5.return();
                        }
                    } finally {
                        if (_didIteratorError5) {
                            throw _iteratorError5;
                        }
                    }
                }
            }
        });
    };

    $scope.getGuardCode();

    $scope.pageGuardInit = function () {
        if (!$rootScope.clockInterval) {
            $rootScope.clockInterval = $interval($rootScope.clock, 1000);
        }
    };

    // $scope.cardGreen();
}]);

angular.module('myApp.controllers_guard_apply', [])
//保安门岗扫用户
.controller('guard_applyCtrl', ['$scope', '$rootScope', '$http', '$timeout', '$interval', function ($scope, $rootScope, $http, $timeout, $interval) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    $scope.applys = [];

    if (!!$rootScope.scanQRCodeData) {
        $scope.scanQRCodeData = $rootScope.scanQRCodeData;
        $rootScope.scanQRCodeData = null;

        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/getInfo',
            method: 'post',
            traditional: true,
            data: {
                cardId: $scope.scanQRCodeData
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                $scope.applys = response.data.applys;
                $scope.passport = response.data;
                console.info($scope.passport);

                if ($scope.passport.mobile && $scope.passport.mobile.length == 11) $scope.passport.mobile = $scope.passport.mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                if ($scope.passport.idCard && $scope.passport.idCard.length == 18) $scope.passport.idCard = $scope.passport.idCard.replace(/^(.{6})(?:\d+)(.{4})$/, "$1********$2");

                $scope.getGuardCode();
                // } else if (response.code == 1) {
                //     $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    }

    $scope.token = $rootScope.work_weixin.token;
    $scope.userdata = JSON.stringify($rootScope.userData);
    $scope.passport = {
        'qr': null,
        'name': null,
        'sex': null,
        'photo': null,
        'number': null,
        'mobile': null,
        'idCard': null,
        'class': null,
        'campus': null
    };
    $scope.guardCampusId = null;
    $scope.guardGateId = null;
    $scope.guardGateStatus = null;
    $scope.guardName = null;
    $scope.campusId = null;
    $scope.guardNameData = {
        'qhb': '前湖北校区',
        'qhn': '前湖南校区',
        'qsh': '青山湖校区',
        'dh': '东湖校区'
    };

    // 生成二维码
    var generateQRCodeCanvas = function generateQRCodeCanvas() {
        var text = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : $scope.scanQRCodeData;
        var foreground = arguments[1];
        var background = arguments[2];
        var type = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

        if (!text) {
            // $rootScope.re_login();
            return false;
        }

        var options = {
            typeNumber: -1,
            correctLevel: QRErrorCorrectLevel.H,
            width: type == 1 ? 150 : 180,
            height: type == 1 ? 150 : 180,
            background: background ? background : "#ffffff",
            foreground: foreground ? foreground : "#163a7b",
            text: text
        };

        var qrcode = new QRCode(options.typeNumber, options.correctLevel);
        qrcode.addData(options.text);
        qrcode.make();

        // create canvas element
        var canvas = document.createElement('canvas');
        canvas.width = options.width;
        canvas.height = options.height;
        var ctx = canvas.getContext('2d');

        // compute tileW/tileH based on options.width/options.height
        var tileW = options.width / qrcode.getModuleCount();
        var tileH = options.height / qrcode.getModuleCount();

        // draw in the canvas
        for (var row = 0; row < qrcode.getModuleCount(); row++) {
            for (var col = 0; col < qrcode.getModuleCount(); col++) {
                ctx.fillStyle = qrcode.isDark(row, col) ? options.foreground : options.background;
                var w = Math.ceil((col + 1) * tileW) - Math.floor(col * tileW);
                var h = Math.ceil((row + 1) * tileW) - Math.floor(row * tileW);
                ctx.fillRect(Math.round(col * tileW), Math.round(row * tileH), w, h);
            }
        }
        ctx.globalAlpha = 0;
        jQuery('.qr-code-canvas .canvas').html(canvas);
    };

    // 获取当前门岗
    $scope.getGuardCode = function () {
        if ($rootScope.campusData) {
            $scope.guardCampusId = $rootScope.campusData.campus;
            $scope.guardGateId = $rootScope.campusData.gateId;
            $scope.getCampusItinerary();
        }
    };

    // 获取校区识别卡
    $scope.campusItineraryList = {
        '100002': 0,
        '100004': 0,
        '100001': 0,
        '100003': 0
    };
    $scope.campusItineraryNameList = {
        '前湖北校区': 100002,
        '前湖南校区': 100004,
        '青山湖校区': 100001,
        '东湖校区': 100003
    };
    $scope.getCampusItinerary = function () {
        if ($scope.applys && $scope.applys.length > 0) {
            var _iteratorNormalCompletion6 = true;
            var _didIteratorError6 = false;
            var _iteratorError6 = undefined;

            try {
                for (var _iterator6 = $scope.applys[Symbol.iterator](), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
                    var _item3 = _step6.value;

                    var nowTime = new Date().Format('yyyy-MM-dd hh:mm:ss');
                    if (_item3.status == '1') {
                        if (_item3.startTime <= nowTime && _item3.endTime >= nowTime && _item3.status == '1' && _item3.applyCampus) {
                            // 当天的许可列表
                            $scope.campusItineraryList[$scope.campusItineraryNameList[_item3.applyCampus]] = ++$scope.campusItineraryList[$scope.campusItineraryNameList[_item3.applyCampus]];
                        }
                    }
                }
            } catch (err) {
                _didIteratorError6 = true;
                _iteratorError6 = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion6 && _iterator6.return) {
                        _iterator6.return();
                    }
                } finally {
                    if (_didIteratorError6) {
                        throw _iteratorError6;
                    }
                }
            }
        }
        // alert(JSON.stringify($scope.passport));
        // 学生
        if ($scope.passport.type == 1) {
            $scope.renderCampusBox();
            $scope.getGuardId(function (gateId) {
                var foreground = "#163a7b";
                var background = "#ffffff";
                if ($scope.passport.cardStatus == 0) {
                    // 长期通行
                    $scope.stuCardGreen();
                    foreground = "#163a7b";
                } else if ($scope.passport.cardStatus == 1) {
                    // 要看通行许可
                    if ($scope.campusItineraryList[$scope.guardCampusId] > 0) {
                        $scope.stuCardGreen();
                        foreground = "#163a7b";
                    } else {
                        $scope.stuCardRed();
                        foreground = "#ff4222";
                        $('.stuNoentry').fadeIn();
                    }
                } else if ($scope.passport.cardStatus == 2) {
                    // 在人事处名单即可长期通行
                    $scope.stuCardGreen();
                    foreground = "#163a7b";
                } else if ($scope.passport.cardStatus == 3) {
                    // 通行证失效
                    $scope.stuCardRed();
                    foreground = "#ff4222";
                    $('.nopassport').fadeIn();
                } else if ($rootScope.passport.cardStatus == 4) {
                    // 黄码
                    $scope.stuCardYellow();
                    foreground = "#ffb400";
                }
                generateQRCodeCanvas($scope.passport.qr, foreground, background, 1);
            });
        } else {
            var foreground = "#3d9e00";
            // 4.23在广东，黑龙江打卡1
            if ($rootScope.noEntryUserId.indexOf($scope.passport.userId) >= 0) {
                $('#unapply-buttons').fadeIn();
                $('.qr-box-card').addClass('red').removeClass('green');
                $('.user-info-card').addClass('red').removeClass('green');
                $('.campus-box').removeClass('active');
                foreground = "#ff4222";
                $('.epidemicArea').fadeIn();
            } else {
                // $scope.renderCampusBox();
                // $scope.verificationUserItinerary((flag) => {
                $scope.getGuardId(function (gateId) {
                    $rootScope.isSignSafe(function (SignSafe) {
                        // $scope.isSafe((isSafe) => {
                        if ($scope.passport.cardStatus == 0) {
                            // 长期通行
                            $('#buttons').fadeIn();
                            $scope.cardGreen();
                            foreground = "#3d9e00";
                        } else if ($scope.passport.cardStatus == 1) {
                            // 要看通行许可
                            // if(isSafe) {
                            //     if (flag) { // 是否有教师出行申请
                            //          $('#buttons').fadeIn();
                            //         $scope.cardGreen();
                            //         foreground = "#3d9e00";
                            //     } else {
                            //         if ($scope.campusItineraryList[$scope.guardCampusId] > 0) {
                            if (SignSafe.safe) {
                                $('#buttons').fadeIn();
                                $scope.cardGreen();
                                foreground = "#3d9e00";
                            } else {
                                $scope.cardRed();
                                foreground = "#ff4222";
                                $('.isSignSafeResult').html(SignSafe.result).fadeIn();
                            }
                            // } else {
                            //     $scope.cardRed();
                            //     $('.noentry').fadeIn();
                            // }
                            // }
                            // }else{
                            //     $scope.cardRed();
                            //     foreground = "#ff4222";
                            //     $('.unsafe').fadeIn();
                            // }
                        } else if ($scope.passport.cardStatus == 2) {
                            // 在人事处名单即可长期通行
                            $('#buttons').fadeIn();
                            $scope.cardGreen();
                            foreground = "#3d9e00";
                        } else if ($scope.passport.cardStatus == 3) {
                            // 通行证失效
                            $scope.cardRed();
                            foreground = "#ff4222";
                            $('.nopassport').fadeIn();
                        }
                        generateQRCodeCanvas($scope.passport.qr, foreground);
                        // });
                    });
                });
                // });
            }
        }
    };

    $scope.stuCardYellow = function () {
        $('.qr-box-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.user-info-card').addClass('yellow').removeClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').removeClass('student-qrcode-blue').addClass('student-qrcode-yellow');
    };

    $scope.stuCardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.qr-code-canvas').removeClass('student-qrcode-red').addClass('student-qrcode-blue');
    };

    $scope.stuCardRed = function () {
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.qr-code-canvas').removeClass('student-qrcode-blue').addClass('student-qrcode-red');
    };

    $scope.cardGreen = function () {
        $('.qr-box-card').addClass('green').removeClass('red');
        $('.user-info-card').addClass('green').removeClass('red');
        $('.campus-box').addClass('active');
    };

    $scope.cardRed = function () {
        $('.redcode').fadeIn();
        $('#unapply-buttons').fadeIn();
        $('.qr-box-card').addClass('red').removeClass('green');
        $('.user-info-card').addClass('red').removeClass('green');
        $('.campus-box').removeClass('active');
    };

    // 人事处的返校名单，符合隔离要求
    $scope.isSafe = function (callback) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/isSafe',
            method: 'post',
            data: {
                userId: $scope.passport.userId
                // userId: '091264',
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            // alert('isSafe: ' + JSON.stringify(response));
            if (response.code == 0) {
                callback && callback(response.data);
            }
        });
    };

    // 是否有教师出行申请
    $scope.doGetTeacherRegistrationList = function (callback) {
        var qwxq = {
            '100004': '0', // 前湖南校区
            '100002': '1', // 前湖北校区
            '100001': '2', // 青山湖校区
            '100003': '3' // 东湖校区
        };
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/doRequest/dogetTeacherRegistrationList',
            method: 'post',
            traditional: true,
            data: {
                userCode: $rootScope.userData.userId,
                qwxq: qwxq[$scope.guardCampusId]
            }
        }).then(function (response) {
            console.info(response);
            if (response.status == "200") {
                var flag = false;
                if (response.data && response.data.length > 0) {
                    var _iteratorNormalCompletion7 = true;
                    var _didIteratorError7 = false;
                    var _iteratorError7 = undefined;

                    try {
                        for (var _iterator7 = response.data[Symbol.iterator](), _step7; !(_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done); _iteratorNormalCompletion7 = true) {
                            var _item4 = _step7.value;

                            var isDuringDate = window.isDuringDate(_item4.yjlaixsj, _item4.yjlxsj);
                            if (!!isDuringDate) {
                                if (_item4.qwxq == qwxq[$scope.guardCampusId]) {
                                    flag = true;
                                }
                                for (var xq in qwxq) {
                                    if (qwxq[xq] == _item4.qwxq) {
                                        $scope.campusItineraryList[xq] = ++$scope.campusItineraryList[xq];
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        _didIteratorError7 = true;
                        _iteratorError7 = err;
                    } finally {
                        try {
                            if (!_iteratorNormalCompletion7 && _iterator7.return) {
                                _iterator7.return();
                            }
                        } finally {
                            if (_didIteratorError7) {
                                throw _iteratorError7;
                            }
                        }
                    }
                }$scope.renderCampusBox();
                callback && callback(flag);
            }
        });
    };

    $scope.verificationUserItinerary = function (callback) {
        $scope.doGetTeacherRegistrationList(function (flag) {
            callback && callback(flag);
        });
    };

    $scope.renderCampusBox = function () {
        console.info($scope.campusItineraryList);
        for (var i in $scope.campusItineraryList) {
            if ($scope.campusItineraryList[i] > 0) {
                $('.campus-box.campus_id-' + i).addClass('active');
            }
        }
    };

    $scope.denyGuardCheck = function () {
        $rootScope.go('/guard_scan');
    };

    // 入校记录
    $scope.sendGuardCheck = function (status) {
        $('#checkReark_modal').modal('hide');
        var params = {
            status: status, // 0是入校，1是离校 2无许可入校
            // temperature
            userId: $scope.passport.userId,
            cardId: $scope.passport.cardId,
            gateId: $scope.guardGateId,
            userName: $rootScope.userData.userName,
            deptName: $rootScope.userData.deptName
        };
        if ($scope.checkReark && $scope.checkReark != "") params['remark'] = $scope.checkReark;

        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/check',
            method: 'post',
            data: params,
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                $('.alert-success-recall').fadeIn();
                $('.submit-form-panel').fadeOut();
                $timeout(function () {
                    $rootScope.go('/guard_scan');
                }, 2000);
            } else {
                alert(response.message);
            }
        });
    };

    // 查询门岗id
    $scope.getGuardId = function (callback) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/queryList',
            method: 'post',
            data: {
                campusId: $scope.guardCampusId
                // guardId:
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                var _iteratorNormalCompletion8 = true;
                var _didIteratorError8 = false;
                var _iteratorError8 = undefined;

                try {
                    var _loop2 = function _loop2() {
                        var item = _step8.value;

                        if (item.campusId == $scope.guardCampusId && item.gateId == $scope.guardGateId) {
                            $scope.$apply(function ($scope) {
                                $scope.campusId = item.campusId;
                                $scope.guardName = item.campusName + ' ' + item.gateName;
                            });
                            callback && callback(item.gateId);
                        }
                    };

                    for (var _iterator8 = response.data[Symbol.iterator](), _step8; !(_iteratorNormalCompletion8 = (_step8 = _iterator8.next()).done); _iteratorNormalCompletion8 = true) {
                        _loop2();
                    }
                } catch (err) {
                    _didIteratorError8 = true;
                    _iteratorError8 = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion8 && _iterator8.return) {
                            _iterator8.return();
                        }
                    } finally {
                        if (_didIteratorError8) {
                            throw _iteratorError8;
                        }
                    }
                }
            }
        });
    };

    $scope.pageGuardInit = function () {
        if (!$rootScope.clockInterval) {
            $rootScope.clockInterval = $interval($rootScope.clock, 1000);
        }
    };

    $scope.show_checkReark_modal = function () {
        $('#checkReark_modal').modal('show');
    };

    $scope.checkReark_change = function () {
        // console.info($scope.checkReark);
        if ($scope.checkReark != '') {
            $('#unapply-btn').attr('disabled', false);
        } else {
            $('#unapply-btn').attr('disabled', 'disabled');
        }
    };

    $timeout(function () {
        $('textarea[autoHeight]').autoHeight();
    }, 200);

    // $scope.cardGreen();
}]);

angular.module('myApp.controllers_list_apply', [])
//列表 待审批
.controller('list_applyCtrl', ['$scope', '$rootScope', '$http', '$timeout', function ($scope, $rootScope, $http, $timeout) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    $scope.approvedList = [];
    $scope.unapprovedList = [];
    $scope.approvedListPageNum = 0;
    $scope.unapprovedListPageNum = 0;
    $scope.pageSize = 10;
    $scope.approvedHasLoadMore = false;
    $scope.unapprovedHasLoadMore = false;
    $rootScope.currentItinerary = {};

    // $scope.goto_itinerary_approved = function () {
    //     $rootScope.go('/itinerary_approved');
    // };
    $scope.switch_tab = function ($id) {
        $('.tab-content .tab-pane').fadeOut();
        var id = $id.split('-')[1];
        if (id == 0) {
            $scope.unapprovedList = [];
            $scope.loadList(id, $scope.unapprovedListPageNum);
        } else if (id == 1) {
            $scope.approvedList = [];
            $scope.loadList(1, $scope.approvedListPageNum);
            $scope.loadList(2, $scope.approvedListPageNum);
        }
        $timeout(function () {
            $('.tab-content .tab-pane' + $id).fadeIn();
        }, 500);
    };

    $scope.loadList = function ($id, pageNum) {

        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/queryListByRole',
            method: 'post',
            data: {
                // userId: $rootScope.userData.userId,
                status: $id, // 0 待审核  1 已审核
                size: $scope.pageSize,
                num: pageNum
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                if (response.data && response.data.length > 0) {
                    console.info(response.data);
                    if ($id == 0) {
                        if (response.data.length == 10) $scope.unapprovedHasLoadMore = true;else $scope.unapprovedHasLoadMore = false;
                        $scope.$apply(function ($scope) {
                            $scope.unapprovedList = $scope.unapprovedList.concat(response.data);
                            // 时间倒序
                            $scope.unapprovedList.sort(function (a, b) {
                                return a.createTime < b.createTime ? 1 : -1;
                            });
                        });
                    } else if ($id == 1 || $id == 2) {
                        if (response.data.length == 10) $scope.approvedHasLoadMore = true;else $scope.approvedHasLoadMore = false;
                        $scope.$apply(function ($scope) {
                            $scope.approvedList = $scope.approvedList.concat(response.data);
                            // 时间倒序
                            $scope.approvedList.sort(function (a, b) {
                                return a.createTime < b.createTime ? 1 : -1;
                            });
                        });
                    }
                }
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    };

    $scope.list_load_more = function ($id) {
        if ($id == 0) {
            ++$scope.unapprovedListPageNum;
            $scope.loadList($id, $scope.unapprovedListPageNum);
        } else if ($id == 1 || $id == 2) {
            ++$scope.approvedListPageNum;
            $scope.loadList($id, $scope.approvedListPageNum);
        }
    };

    $timeout(function () {
        // $scope.list_load_more(0);
        $('#home-tab').click();
    }, 100);

    $scope.query = function ($data) {
        $rootScope.go('/detail_apply', { applyDetail: $data });
    };
}]);

angular.module('myApp.controllers_detail_apply', [])
//审批操作
.controller('detail_applyCtrl', ['$scope', '$rootScope', '$http', '$timeout', '$routeParams', function ($scope, $rootScope, $http, $timeout, $routeParams) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    $scope.checkReark = null;
    $scope.applyData = null;
    if ($routeParams.applyDetail) {
        var data = $routeParams.applyDetail;
        $scope.applyData = data;
    }

    $scope.check = function (check) {
        $scope.checkReark = $('textarea#remark').val();
        if (!$scope.checkReark) {
            if (check) $scope.checkReark = '同意';else $scope.checkReark = '拒绝';
        }

        var ids = [];
        ids[0] = $scope.applyData.id;

        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/check?remark=' + $scope.checkReark + '&check=' + check,
            method: 'post',
            data: JSON.stringify(ids),
            // {
            //     ids: ,

            // },
            dataType: "json",
            processData: false,
            headers: {
                'Content-Type': 'application/json',
                "token": $rootScope.work_weixin.token
            },
            traditional: true
        }).then(function (response) {
            if (response.code == 0) {
                if (response.message == "success") {
                    $('.alert-success-detail').fadeIn();
                    $timeout(function () {
                        $rootScope.go('/list_apply');
                    }, 2000);
                }
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    };

    $timeout(function () {
        $('textarea[autoHeight]').autoHeight();
    }, 200);
}]);

angular.module('myApp.controllers_guard_scan', [])
// 保安门岗扫码
.controller('guard_scanCtrl', ['$scope', '$rootScope', '$http', '$timeout', '$routeParams', function ($scope, $rootScope, $http, $timeout, $routeParams) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();
    if (!$rootScope.campusData) $rootScope.go('/guard_welcome');

    $scope.goto_passport = function () {
        $rootScope.go('/passport');
    };
    jQuery.ajax({
        url: $rootScope.apiUrl + '/system/auth/getTicket',
        method: 'get',
        data: {
            url: window.location.href.split('#')[0]
        },
        traditional: true
    }).then(function (response) {
        if (response.data) {
            wx.config({
                beta: true, // 必须这么写，否则wx.invoke调用形式的jsapi会有问题
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: response.data.appId, // 必填，企业微信的corpID
                timestamp: response.data.timestamp, // 必填，生成签名的时间戳
                nonceStr: response.data.nonceStr, // 必填，生成签名的随机串
                signature: response.data.signature, // 必填，签名，见 附录-JS-SDK使用权限签名算法
                jsApiList: ['checkJsApi', 'scanQRCode'] // 必填，需要使用的JS接口列表，凡是要调用的接口都需要传进来
            });

            wx.error(function (res) {
                // $('#test-result').val('出错了' + JSON.stringify(err));
                // alert("出错了：" + res.errMsg);//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
            });

            wx.ready(function () {
                wx.checkJsApi({
                    jsApiList: ['scanQRCode'],
                    success: function success(res) {}
                });

                //电子ID扫码
                document.querySelector('#scanQRCode').onclick = function () {
                    wx.scanQRCode({
                        needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                        scanType: ["qrCode"], // 可以指定扫二维码还是一维码，默认二者都有
                        success: function success(res) {
                            var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                            // $('#test-result').val(JSON.stringify(res));
                            $rootScope.scanQRCodeData = result;
                            $rootScope.go('/guard_apply');
                        }
                    });
                };

                // 昌通码扫码
                document.querySelector('#ncQRCode').onclick = function () {
                    wx.scanQRCode({
                        needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                        scanType: ["qrCode"], // 可以指定扫二维码还是一维码，默认二者都有
                        success: function success(res) {
                            var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                            $rootScope.NCrqcodeOriginal = result.split('unionCode=')[1];
                            $rootScope.NCrqcode = encodeURIComponent(encodeURIComponent($rootScope.NCrqcodeOriginal));
                            $scope.sendNCcode($rootScope.NCrqcode);
                        }
                    });
                };
            });
        }
    }).fail(function (err) {
        // $('#test-result').val('err' + JSON.stringify(err));
    });

    // TEST ⚡️
    // $rootScope.getToken();
    // $rootScope.getUserData(() => {
    //     document.querySelector('#scanQRCode').onclick = () => {
    //         $rootScope.scanQRCodeData = '11140508502016170568';
    //         $rootScope.go('/guard_apply');
    //     };
    //     document.querySelector('#ncQRCode').onclick = () => {
    //         const url = 'https://elecard.hcctm.com/elecard/card.html?unionCode=PqvTTHXjdisXvy4aj82FNIA4giQlVXkDsxDJs8eq/nE=';
    //         $rootScope.NCrqcodeOriginal = url.split('unionCode=')[1];
    //         $rootScope.NCrqcode = encodeURIComponent(encodeURIComponent($rootScope.NCrqcodeOriginal));
    //         $scope.sendNCcode($rootScope.NCrqcode);
    //     };
    // });

    $scope.sendNCcode = function () {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/visitor/guardCheckVisitor',
            method: 'post',
            data: {
                ctm: $rootScope.NCrqcode
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                $rootScope.go('/visitor_passport', { passport: JSON.stringify(response.data) });
            } else if (response.code == 1) {
                alert(response.message);
            } else {
                alert(response.message);
            }
        });
    };
}]);

angular.module('myApp.controllers_guard_welcome', [])
// 保安门岗选择校区
.controller('guard_welcomeCtrl', ['$scope', '$rootScope', '$http', '$timeout', '$routeParams', function ($scope, $rootScope, $http, $timeout, $routeParams) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    // $scope.goto_guard_scan = () => {
    //     $rootScope.campusData = {
    //         campus: $scope.activeCampus,
    //         gateId: $scope.activeGateId
    //     };
    //     $rootScope.go('/guard_scan');
    // };

    var forms = $('form');
    var validation = Array.prototype.filter.call(forms, function (form) {
        $('#gateId_select').removeClass('invalid');
        form.addEventListener('submit', function (event) {
            $('.custom-select, .form-control').removeClass('invalid valid');
            var validityFlag = false;

            if ($('#gateId_select').val() == "? object:null ?") {
                $('#gateId_select').addClass('invalid');
                validityFlag = true;
            } else {
                if (form.checkValidity() === false || validityFlag) {
                    event.preventDefault();
                    event.stopPropagation();
                } else {
                    $rootScope.campusData = {
                        campus: $scope.activeCampus,
                        gateId: $scope.activeGateId
                    };
                    $rootScope.go('/guard_scan');
                    // TEST ⚡️
                    // $rootScope.go('/guard_apply');
                }
            }
            form.classList.add('was-validated');
        }, false);
    });

    $scope.guardList = {};
    $scope.activeCampus = '100002';
    $scope.activeGuardList = [];
    $scope.activeGateId = null;

    // 查询门岗id
    $scope.getGuardList = function () {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/queryList',
            method: 'post',
            data: {},
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                var _iteratorNormalCompletion9 = true;
                var _didIteratorError9 = false;
                var _iteratorError9 = undefined;

                try {
                    for (var _iterator9 = response.data[Symbol.iterator](), _step9; !(_iteratorNormalCompletion9 = (_step9 = _iterator9.next()).done); _iteratorNormalCompletion9 = true) {
                        var _item5 = _step9.value;

                        if ($rootScope.schoolGateId.indexOf(_item5.gateId) >= 0) {
                            if ($scope.guardList[_item5.campusId]) {
                                $scope.guardList[_item5.campusId].push(_item5);
                            } else {
                                $scope.guardList[_item5.campusId] = [_item5];
                            }
                        }
                    }
                } catch (err) {
                    _didIteratorError9 = true;
                    _iteratorError9 = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion9 && _iterator9.return) {
                            _iterator9.return();
                        }
                    } finally {
                        if (_didIteratorError9) {
                            throw _iteratorError9;
                        }
                    }
                }

                $scope.$apply(function ($scope) {
                    $scope.activeGuardList = $scope.guardList[$scope.activeCampus];
                });
                console.info($scope.guardList);
            }
        });
    };
    $scope.getGuardList();

    $scope.campus_select_change = function () {
        console.info($scope.activeCampus);
        $scope.activeGuardList = $scope.guardList[$scope.activeCampus];
    };
}]);

angular.module('myApp.controllers_itinerary_approved', [])
//申请详情
.controller('itinerary_approvedCtrl', ['$scope', '$rootScope', '$http', '$timeout', '$routeParams', function ($scope, $rootScope, $http, $timeout, $routeParams) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    if ($routeParams.itineraryID) {
        var $id = $routeParams.itineraryID;
        // 查询详情
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/query',
            // url: 'http://192.168.16.103:8086/gate/apply/query',
            method: 'post',
            traditional: true,
            data: {
                id: $id
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            console.info(response.data);
            if (response.code == 0) {
                $scope.$apply(function ($scope) {
                    $rootScope.currentItinerary = response.data;
                    $scope.itinerary = $rootScope.currentItinerary;
                });
                $timeout(function () {}, 100);
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    }
    $scope.attachment = document.getElementById('attachment').files[0];

    $('#datetimepicker-start').datetimepicker(_extends({}, $rootScope.datepickerOptions, {
        startDate: new Date()
    }));
    $('#datetimepicker-end').datetimepicker(_extends({}, $rootScope.datepickerOptions, {
        startDate: new Date(),
        useCurrent: false
    }));

    $("#datetimepicker-start").datetimepicker().on("hide", function (e) {
        if (!!e.currentTarget.value) {
            var value = e.currentTarget.value;
            value = value.split(':')[0] + ":" + value.split(':')[1] + ":00";
            $('#datetimepicker-start').val(value).datetimepicker('update');
            $scope.itinerary.startTime = value;

            // let midnightTime = e.currentTarget.value.split(' ')[0] + ' 23:59:59';
            // $('#datetimepicker-end').val(midnightTime).datetimepicker('setStartDate', e.currentTarget.value).datetimepicker('setEndDate', midnightTime).datetimepicker('update');
            $('#datetimepicker-end').datetimepicker('setStartDate', e.currentTarget.value).datetimepicker('update');
            // $scope.itinerary.endTime = midnightTime;
        }
    });

    // 撤回
    $scope.recall = function ($id, $event) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/revocation',
            // url: 'http://192.168.16.103:8086/gate/apply/revocation',
            method: 'post',
            traditional: true,
            data: {
                id: $id
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            console.info(response.data);
            if (response.code == 0) {
                $('#recall-btn').attr('disabled', 'disabled');
                $scope.itinerary.status = 3;
                $rootScope.currentItinerary.status = 3;
                $('.alert-success-recall').fadeIn();
                $timeout(function () {
                    $rootScope.go('/passport');
                }, 2000);
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    };

    // 删除
    $scope.deleteItinerary = function ($id, $event) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/apply/delApply',
            method: 'post',
            traditional: true,
            data: {
                id: $id
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            console.info(response.data);
            if (response.code == 0) {
                $('#submit-btn').attr('disabled', 'disabled');
                $rootScope.currentItinerary = null;
                $('.alert-success-delete').fadeIn();
                $timeout(function () {
                    $rootScope.go('/passport');
                }, 2000);
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    };

    $(document).on('change', '#attachment', function (e) {
        var $file = e.target.files[0];
        $rootScope.verificationAttachment($file, function () {
            $scope.$apply(function ($scope) {
                $scope.fileName = $file.name;
            });
            $('.attachment-button').addClass('complete');
        });
    });

    $scope.addAttachment = function (callback) {
        $scope.attachment = document.getElementById('attachment').files[0];

        if ($scope.attachment) {
            var formData = new FormData();
            formData.append("file", $scope.attachment);
            $http.post($rootScope.apiUrl + "/system/file/upload", formData, {
                transformRequest: angular.identity,
                headers: { 'Content-Type': undefined }
            }).success(function (response) {
                if (response.code == 0) {
                    callback && callback(response.data);
                } else {
                    alert(response.message);
                    $('.attachment-button').removeClass('complete').addClass('fail');
                }
            });
        } else {
            callback && callback(null);
        }
    };

    $scope.editItinerary = function () {
        $scope.addAttachment(function (filePath) {
            var data = {
                // userId: $rootScope.userData.userId,
                id: $scope.itinerary.id,
                userId: $scope.itinerary.userId,
                cardId: $scope.itinerary.cardId,
                campusId: $scope.itinerary.campusId,
                startTime: $scope.itinerary.startTime,
                endTime: $scope.itinerary.endTime,
                remark: $scope.itinerary.remark,
                status: 0
            };
            if (!!filePath) data['filePath'] = filePath;

            jQuery.ajax({
                url: $rootScope.apiUrl + '/gate/apply/editApply',
                // url: 'http://192.168.16.103:8086/gate/apply/editApply',
                method: 'post',
                // contentType: 'application/json;charset=UTF-8',
                traditional: true,
                data: data,
                headers: {
                    "token": $rootScope.work_weixin.token
                }
                // type: 'json',
            }).then(function (response) {
                console.info(response);
                if (response.code == 0) {
                    $('#submit-btn').attr('disabled', 'disabled');
                    $('#delete-btn').attr('disabled', 'disabled');
                    $('.alert-success-itinerary').fadeIn();
                    $timeout(function () {
                        $rootScope.go('/passport');
                    }, 2000);
                } else if (response.code == 1) {
                    alert(response.message);
                    $rootScope.re_login();
                } else {
                    alert(response.message);
                }
            });
        });
    };

    $scope.attachment_button = function () {
        document.getElementById('attachment').click();
    };

    // 表单校验
    var forms = $('form');
    var validation = Array.prototype.filter.call(forms, function (form) {
        form.addEventListener('submit', function (event) {
            $('.custom-select, .form-control').removeClass('invalid valid');
            var validityFlag = false;
            if (!$('#datetimepicker-start').val()) {
                validityFlag = true;
                $('#datetimepicker-start').addClass('invalid');
            } else $('#datetimepicker-start').addClass('valid');
            if (!$('#datetimepicker-end').val()) {
                validityFlag = true;
                $('#datetimepicker-end').addClass('invalid');
            } else $('#datetimepicker-end').addClass('valid');

            if (form.checkValidity() === false || validityFlag) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                $scope.editItinerary();
            }
            form.classList.add('was-validated');
        }, false);
    });

    $timeout(function () {
        $('textarea[autoHeight]').autoHeight();
    }, 200);
}]);

angular.module('myApp.controllers_list_approved', [])
//列表 出行记录
.controller('list_approvedCtrl', ['$scope', '$rootScope', '$http', '$timeout', function ($scope, $rootScope, $http, $timeout) {
    if (!$rootScope.userData || !$rootScope.userData.userId) $rootScope.re_login();

    $scope.list = [];
    $scope.pageNum = 0;
    $scope.pageSize = 10;
    $scope.hasLoadMore = false;
    $rootScope.currentItinerary = {};

    // $scope.goto_itinerary_approved = function () {
    //     $rootScope.go('/itinerary_approved');
    // };

    $scope.loadList = function (pageNum) {
        jQuery.ajax({
            url: $rootScope.apiUrl + '/gate/guard/queryLog',
            // url: 'http://192.168.16.103:8086/gate/apply/queryList',
            method: 'post',
            traditional: true,
            data: {
                // userId: $rootScope.userData.userId,
                date: new Date().Format('yyyy-MM-dd'),
                size: $scope.pageSize,
                num: pageNum
            },
            headers: {
                "token": $rootScope.work_weixin.token
            }
        }).then(function (response) {
            if (response.code == 0) {
                if (response.data && response.data.length > 0) {
                    console.info(response.data);
                    if (response.data.length == 10) $scope.hasLoadMore = true;else $scope.hasLoadMore = false;
                    $scope.$apply(function ($scope) {
                        $scope.list = $scope.list.concat(response.data);
                        // 时间倒序
                        $scope.list.sort(function (a, b) {
                            return a.createTime < b.createTime ? 1 : -1;
                        });
                    });
                }
            } else if (response.code == 1) {
                alert(response.message);
                $rootScope.re_login();
            } else {
                alert(response.message);
            }
        });
    };

    $scope.list_load_more = function () {
        ++$scope.pageNum;
        $scope.loadList($scope.pageNum);
    };

    $scope.list_load_more();

    $scope.query = function ($item) {
        // 出行记录查询详情
        $rootScope.itineraryLog = $item;
        $rootScope.go('/itinerary_approvedLog');
    };
}]);
